<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Web Nghe Nh·∫°c</title>
    <link rel="stylesheet" href="../static/style/musicpage.css">
</head>

<body>
    <h1>üéµ Danh s√°ch b√†i nh·∫°c üéµ</h1>

    <div class="music-list">
        {% for file in music_files %}
        <div class="music-card">
            <p class="music-title">{{ file }}</p>
            <audio controls>
                <source src="{{ url_for('play_music', filename=file) }}" type="audio/mpeg">
                Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ audio.
            </audio>
        </div>
        {% endfor %}
    </div>
    {% if role == 'artist' %}
    <a href="/upload">Upload Music</a>
    {% endif %}
    <script>
        // function base64ToArrayBuffer(base64) {
        //     const binaryString = atob(base64);
        //     const bytes = new Uint8Array(binaryString.length);
        //     for (let i = 0; i < binaryString.length; i++) {
        //         bytes[i] = binaryString.charCodeAt(i);
        //     }
        //     return bytes.buffer;
        // }
        function hexToArrayBuffer(hex) {
            const len = hex.length / 2;
            const buf = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                buf[i] = parseInt(hex.substr(i * 2, 2), 16);
            }
            return buf.buffer;
        }

        async function arrayBufferToHex(buffer) {
            return Array.from(new Uint8Array(buffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function main() {
            const res = await fetch("/key-exchange");
            const {
                server_pubkey_ecdhe,
                signature,
                server_pubkey_ecdsa
            } = await res.json();

            const ecdheBuf = base64ToArrayBuffer(server_pubkey_ecdhe);
            const sigBuf = base64ToArrayBuffer(signature);
            const ecdsaBuf = base64ToArrayBuffer(server_pubkey_ecdsa);

            const serverECDSAPubKey = await crypto.subtle.importKey(
                "spki",
                ecdsaBuf,
                { name: "ECDSA", namedCurve: "P-256" },
                true,
                ["verify"]
            );

            const verified = await crypto.subtle.verify(
                { name: "ECDSA", hash: "SHA-256" },
                serverECDSAPubKey,
                sigBuf,
                ecdheBuf
            );

            if (!verified) {
                alert("‚ùå Ch·ªØ k√Ω c·ªßa server kh√¥ng h·ª£p l·ªá");
                return;
            }

            console.log("‚úÖ Server signature verified");

            const serverECDHPubKey = await crypto.subtle.importKey(
                "raw",
                ecdheBuf,
                { name: "ECDH", namedCurve: "P-256" },
                true,
                []
            );

            const clientKeys = await crypto.subtle.generateKey(
                { name: "ECDH", namedCurve: "P-256" },
                true,
                ["deriveBits"]
            );

            const sharedSecret = await crypto.subtle.deriveBits(
                {
                    name: "ECDH",
                    public: serverECDHPubKey
                },
                clientKeys.privateKey,
                256
            );

            const sharedHex = await arrayBufferToHex(sharedSecret);
            console.log("üîê Shared secret (client):", sharedHex);


            const clientPubRaw = await crypto.subtle.exportKey("raw", clientKeys.publicKey);
            const clientPubB64 = btoa(String.fromCharCode(...new Uint8Array(clientPubRaw)));

            await fetch("/submit-client-key", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ client_pubkey_ecdhe: clientPubB64 })
            });
        }

        main();
    </script>


</body>

</html>