<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Web Nghe Nh·∫°c</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style/musicpage.css') }}">
</head>

<body>
    <h1>üéµ Danh s√°ch b√†i nh·∫°c üéµ</h1>

    <div class="music-list">
        {% for file in music_files %}
        <div class="music-card">
            <p class="music-title">{{ file }}</p>
            <audio controls>
                <source src="{{ url_for('play_music', filename=file) }}" type="audio/mpeg">
                Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ audio.
            </audio>
        </div>
        {% endfor %}
    </div>
    {% if role == 'artist' %}
    <a href="/upload">Upload Music</a>
    {% endif %}

    <script>
        // Chuy·ªÉn hex string ‚Üí ArrayBuffer
        function hexToArrayBuffer(hex) {
            const len = hex.length / 2;
            const buf = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                buf[i] = parseInt(hex.substr(i * 2, 2), 16);
            }
            return buf.buffer;
        }

        // Chuy·ªÉn ArrayBuffer ‚Üí hex string
        function arrayBufferToHex(buffer) {
            const bytes = new Uint8Array(buffer);
            return Array.from(bytes)
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function main() {
            // 1. L·∫•y pubkey server + signature
            const res1 = await fetch("/key-exchange");
            if (!res1.ok) throw new Error("Key exchange l·ªói: " + res1.status);
            const { server_pubkey_ecdhe, signature, server_pubkey_ecdsa } = await res1.json();

            const ecdheBuf = hexToArrayBuffer(server_pubkey_ecdhe);
            const sigBuf   = hexToArrayBuffer(signature);
            const ecdsaBuf = hexToArrayBuffer(server_pubkey_ecdsa);

            // 2. Verify ch·ªØ k√Ω server
            const serverECDSAPubKey = await crypto.subtle.importKey(
                "spki", ecdsaBuf,
                { name: "ECDSA", namedCurve: "P-256" },
                true, ["verify"]
            );
            const ok = await crypto.subtle.verify(
                { name: "ECDSA", hash: "SHA-256" },
                serverECDSAPubKey, sigBuf, ecdheBuf
            );
            if (!ok) {
                alert("‚ùå Ch·ªØ k√Ω c·ªßa server kh√¥ng h·ª£p l·ªá");
                return;
            }
            console.log("‚úÖ Server signature verified");

            // 3. Derive shared secret
            const serverECDHPubKey = await crypto.subtle.importKey(
                "raw", ecdheBuf,
                { name: "ECDH", namedCurve: "P-256" },
                true, []
            );
            const clientKeys = await crypto.subtle.generateKey(
                { name: "ECDH", namedCurve: "P-256" },
                true, ["deriveBits"]
            );
            const sharedSecret = await crypto.subtle.deriveBits(
                { name: "ECDH", public: serverECDHPubKey },
                clientKeys.privateKey, 256
            );
            console.log("üîê Shared secret (client):", arrayBufferToHex(sharedSecret));

            // 4. Export public key c·ªßa client, convert ‚Üí hex, r·ªìi POST
            const rawPub = await crypto.subtle.exportKey("raw", clientKeys.publicKey);
            const hexPub = arrayBufferToHex(rawPub);
            console.log("Client ECDHE pubkey (hex):", hexPub);

            const res2 = await fetch("/submit-client-key", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ client_pubkey_ecdhe: hexPub })
            });
            if (!res2.ok) {
                const err = await res2.text();
                throw new Error("submit-client-key l·ªói: " + res2.status + " ‚Äì " + err);
            }
            console.log("‚úÖ ƒê√£ submit client key th√†nh c√¥ng");
        }

        main().catch(console.error);
    </script>
</body>
</html>
